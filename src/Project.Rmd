```{r}
library(haven)
full_data <- read_dta('data/04599-0002-Data.dta')
```

```{r}
# list of outcomes we may want to study
# the ones from the paper are "SEGRADES", "SEBEHAVR", "SESCHLWR"
outcomes <- c("SEGRADES", "SEBEHAVR", "SESCHLWR")
# outcomes <- c("SEGRADES", "SEBEHAVR", "SESCHLWR", "SEGRADEQ", "SESUSOUT", "SESUSPIN")

# list of covariates we choose to take into account
# sex, age, race/ethnicity, mothers' educational levels, mothers' marital status, childcare subsidy, and community levels
covariates <- c("SEX", "AGE2004", "RACEETHN", "MOMEDUC", "MOMSTAT", "ZIPURB")

# <<<<<<< HEAD
dat <- full_data[, c("HGOVCUR", outcomes, covariates)]
```

```{r}
# variables we can use for sample selection and stuff
others <- c("SCHLTYPE", "MOMEMPLD", "HINCOME", "ANYCARE", "HOMESCHL", "HH18OVER", "HHTOTAL", "HHUNDR18", "CENREG")

# select the sample used for study
# dat <- select_sample(full_data)
dat <- full_data

# Exclude homeschooled children
nrow(subset(full_data, HOMESCHL == 1))
dat <- subset(dat, HOMESCHL != 1)
nrow(dat)

# Select low-income families only
# Exclude families from group 14
nrow(subset(dat, HINCOME == 14))
dat <- subset(dat, HINCOME <= 13)
income_medians <- c(2500, 7500, 12500, 17500, 22500, 27500, 32500, 37500, 42500, 47500, 55000, 67500, 87500)
threshold <- c(9310 + seq(0, 10) * 3180)

dat <- subset(dat, income_medians[HINCOME] < 2 * threshold[HHTOTAL])
nrow(dat)

# Select households with employed mothers
dat <- subset(dat, MOMEMPLD == 1)
# dat <- subset(dat, MOMFTFY == 1)
nrow(dat)

# Select children that receive some type of after school care
dat <- subset(dat, RCNOW == 1 | CPSNOW == 1 | SCSELF == 1 | PAAHOME == 1)
nrow(dat)

# Drop children from ethnicities other than Black / Hispanic / White
dat <- subset(dat, RACEETHN < 4)
nrow(dat)
```


```{r}
# Sanity checks

# receiving care from a relative other than a parent on a regular basis after school, for example, from grandparents, brothers or sisters, or any other relatives ~ 26.2 %
nrow(subset(dat, RCNOW == 1)) / nrow(dat)

# # receiving care in your home or another home on a regular basis after school from someone who is not related to them
# nrow(subset(dat, NCNOW == 1)) / nrow(dat)

# now attending an after- school program at a school or in a center, either on a scheduled or a drop-in basis ~ 17.1%
nrow(subset(dat, CPSNOW == 1)) / nrow(dat)
# nrow(subset(dat, ASCOVER == 1)) / nrow(dat)

# is (CHILD) responsible for (himself/herself) after school on a regular basis ~ 13.2%
nrow(subset(dat, SCSELF == 1)) / nrow(dat)

# PARENT AT HOME AFTER SCHOOL ~ 36%
nrow(subset(dat, PAAHOME == 1)) / nrow(dat)

# White ~ 33.9%
nrow(subset(dat, RACEETHN == 1)) / nrow(dat)
# Black ~ 23%
nrow(subset(dat, RACEETHN == 2)) / nrow(dat)
# Hispanic ~ 43.1%
nrow(subset(dat, RACEETHN == 3)) / nrow(dat)

# Is a state government or welfare agency currently helping you pay for any child care costs ~ 16.4
nrow(subset(dat, HGOVCUR == 1)) / nrow(dat)
```
>>>>>>> origin/main

ATE estimation of academic score
```{r}
# preprocess data for logistic regression
lr_data <- dat
# change values in binary columns to 1 and 0
lr_data$SCSELF[lr_data$SCSELF == 2] <- 0
lr_data$SCSELF[lr_data$RCNOW == 2] <- 0
lr_data$SCSELF[lr_data$CPSNOW == 2] <- 0
lr_data$SCSELF[lr_data$PAAHOME == 2] <- 0
lr_data$HGOVCUR[lr_data$HGOVCUR == 2] <- 0


summary(glm(SEGRADES ~ SCSELF + RCNOW + CPSNOW + PAAHOME + as.factor(SEX) + AGE2004 + as.factor(RACEETHN) + as.factor(MOMEDUC) + as.factor(MOMSTAT) + as.factor(ZIPURB) + HGOVCUR, data=lr_data))
# In the paper, the coefficient is 0.18 and standard deviation is 0.33. 
```


AIPW estimator
```{r}
source("src/aipw.R")
# limit sample to people who were treatment or control
# make HGOVCUR binary in {0,1} instead of {1,2}
# aipw_data <- subset(full_data, HGOVCUR == 1 | HGOVCUR == 2)
# aipw_data$HGOVCUR <- ifelse(aipw_data$HGOVCUR == 1, 1, 0)
aipw_data <- subset(lr_data, HGOVCUR >= 0)

aipw <- aipw_analysis(aipw_data, compute_prop = TRUE, n_bootstrap = 100)

aipw_ate <- aipw[1]
aipw_var <- aipw[2]
```
